# Malware, Virus & Rootkit Detection Guide ü¶†

Comprehensive malware detection and analysis using industry-standard tools combined with AI-powered analysis.

## Overview

The AI Security Scanner includes advanced malware detection capabilities for both Linux and Windows systems. It combines multiple detection engines with AI analysis to provide comprehensive threat detection and remediation guidance.

## Linux Malware Detection

### Tools Integrated

1. **ClamAV** - Open-source antivirus engine
   - Virus and malware signature detection
   - Over 8 million signatures
   - Real-time updates
   - Multi-threaded scanning

2. **rkhunter (Rootkit Hunter)** - Rootkit detection
   - Checks for known rootkits
   - Scans for suspicious files
   - Verifies system binaries
   - Detects hidden files/processes

3. **chkrootkit** - Alternative rootkit scanner
   - Fast rootkit detection
   - Checks common attack vectors
   - Detects system modifications
   - Process hiding detection

4. **AI Analysis** - Intelligent threat assessment
   - Behavior analysis
   - Anomaly detection
   - Context-aware recommendations
   - Priority-based remediation

### Usage

```bash
cd /path/to/ai-security-scanner
./scripts/malware-scanner.sh
```

### What It Scans

**Virus & Malware Detection (ClamAV):**
- Home directories (`/home`)
- Root directory (`/root`)
- Temporary directories (`/tmp`, `/var/tmp`)
- Web directories (`/var/www`)
- Application directories (`/opt`, `/usr/local`)

**Rootkit Detection (rkhunter + chkrootkit):**
- System binaries verification
- Hidden files and directories
- Kernel module analysis
- Process hiding detection
- Network interface promiscuous mode
- Suspicious strings in system files

**Process Analysis:**
- Running processes and their origins
- Network connections and listening ports
- Hidden processes (ps vs /proc)
- Suspicious process names and locations
- Unusual parent-child relationships
- Resource consumption patterns

**File System Analysis:**
- Recently modified files in /tmp and /var/tmp
- Recently modified SUID/SGID binaries
- Hidden files in system directories
- World-writable directories
- Orphaned files (no owner)
- Suspicious shell scripts

**Web Shell Detection:**
- PHP, ASP, JSP, and shell script analysis
- Detection of eval(), exec(), base64_decode()
- Command execution functions
- File upload handlers
- Suspicious encoding patterns

### Installation Requirements

The scanner will automatically install required tools if missing:
- ClamAV and freshclam (virus definitions)
- rkhunter
- chkrootkit
- jq (JSON processing)

Debian/Ubuntu:
```bash
sudo apt-get install clamav clamav-daemon rkhunter chkrootkit jq
```

RHEL/CentOS:
```bash
sudo yum install clamav rkhunter chkrootkit jq
```

### First Run Setup

On first run, the scanner will:
1. Check for required tools
2. Install missing tools (with permission)
3. Update ClamAV virus definitions
4. Update rkhunter database
5. Begin comprehensive scan

**Note:** Initial virus definition download may take 5-10 minutes.

### Scan Duration

Typical scan times:
- Small server (< 100GB): 10-15 minutes
- Medium server (100-500GB): 20-30 minutes
- Large server (> 500GB): 30-60 minutes

You can run in background:
```bash
nohup ./scripts/malware-scanner.sh > /tmp/malware-scan.log 2>&1 &
```

### Report Location

Reports are saved to: `~/security-reports/malware_scan_YYYYMMDD_HHMMSS.md`

Example: `~/security-reports/malware_scan_20250112_140530.md`

## Windows Malware Detection

### Tools Integrated

1. **Windows Defender** - Microsoft's built-in antivirus
   - Real-time protection status
   - Virus definition updates
   - Quick or full system scan
   - Threat detection and quarantine

2. **PowerShell Analysis** - Script and process analysis
   - Running process inspection
   - Network connection analysis
   - Registry persistence detection
   - File system anomaly detection

3. **AI Analysis** - Windows-specific threat intelligence
   - Behavior-based detection
   - Living-off-the-land binary (LOLBin) detection
   - PowerShell obfuscation analysis
   - Contextual recommendations

### Usage

```powershell
# Run as Administrator
cd C:\path\to\ai-security-scanner\windows\scripts

# Quick scan (15-20 minutes)
.\MalwareScanner.ps1 -QuickScan

# Full scan (30-60 minutes)
.\MalwareScanner.ps1 -FullScan

# Default (quick scan)
.\MalwareScanner.ps1
```

### What It Scans

**Windows Defender Scan:**
- Full system virus/malware scan
- Real-time protection status
- Virus definition version
- Recent threats and quarantine
- Automatic definition updates

**Process Analysis:**
- Top 50 processes by memory usage
- Active network connections
- Suspicious command-line patterns
- PowerShell encoded commands
- Hidden or unsigned executables
- Living-off-the-land binary abuse

**File System Analysis:**
- Recent files in %TEMP% directories
- Startup locations (Registry + folders)
- Scheduled tasks
- Hidden files in system directories
- Suspicious file extensions
- Timestamp anomalies

**Registry Persistence:**
- Run/RunOnce keys
- Winlogon modifications
- Services and drivers
- DLL hijacking indicators
- AppInit_DLLs
- Image File Execution Options (IFEO)
- Browser Helper Objects (BHOs)

**Web Shell Detection (IIS):**
- ASP/ASPX/PHP file analysis
- Eval() and exec() detection
- Base64 encoding patterns
- System.Diagnostics.Process usage
- File upload handlers

**Network Analysis:**
- Firewall configuration
- DNS cache (potential C2 domains)
- Hosts file modifications
- Network shares
- Unusual network adapter settings

### Installation Requirements

**Automatic:**
- Windows Defender (built-in)
- PowerShell 5.1+ (built-in)
- Ollama with AI model

**No additional software needed!**

### Administrator Privileges

For complete scanning capabilities, run PowerShell as Administrator:
1. Right-click PowerShell
2. Select "Run as Administrator"
3. Execute scanner script

### Scan Options

**Quick Scan** (15-20 minutes):
```powershell
.\MalwareScanner.ps1 -QuickScan
```
Scans common malware locations (faster)

**Full Scan** (30-60 minutes):
```powershell
.\MalwareScanner.ps1 -FullScan
```
Scans entire system (thorough)

**Custom Model:**
```powershell
.\MalwareScanner.ps1 -Model "llama3.1:8b"
```
Use different AI model

### Report Location

Reports are saved to: `%USERPROFILE%\security-reports\malware_scan_YYYYMMDD_HHMMSS.md`

Example: `C:\Users\Admin\security-reports\malware_scan_20250112_140530.md`

## Understanding the Report

### Report Sections

Both Linux and Windows reports contain:

1. **Executive Summary**
   - Overall security status
   - Number of threats detected
   - Risk level assessment

2. **Virus/Malware Scan Results**
   - Detected viruses and malware
   - File locations
   - Threat severity
   - Recommended actions

3. **Rootkit Scan Results** (Linux only)
   - Known rootkit signatures
   - System modifications
   - Hidden processes/files
   - Kernel module analysis

4. **Process Analysis**
   - Suspicious running processes
   - Network connections
   - Process origins and legitimacy
   - Resource consumption

5. **File System Findings**
   - Suspicious files and locations
   - Permission issues
   - Recent modifications
   - Hidden or orphaned files

6. **Web Shell Detection** (if applicable)
   - Potential web shells
   - Malicious code patterns
   - Compromised web files

7. **AI Analysis & Recommendations**
   - Risk assessment
   - Prioritized findings
   - Step-by-step remediation
   - Prevention recommendations

### Threat Severity Levels

- **üî¥ CRITICAL** - Active malware detected, immediate action required
- **üü† HIGH** - Suspicious activity, investigate immediately
- **üü° MEDIUM** - Potential risks, review and address soon
- **üü¢ LOW** - Minor issues, monitor or address during maintenance
- **‚úÖ CLEAN** - No threats detected

## Common Threats Detected

### Linux

**Malware:**
- Backdoors (php-backdoor, c99 shell)
- Cryptominers (xmrig, minergate)
- Botnets (Mirai, Gafgyt)
- Trojans (Linux.Tsunami, Linux.Gafgyt)
- Worms (Linux.Wifatch)

**Rootkits:**
- LRK (Linux Rootkit)
- Knark
- T0rn
- Diamorphine
- Reptile

**Web Shells:**
- c99 shell
- r57 shell
- WSO (Web Shell by Orb)
- b374k
- p0wny shell

### Windows

**Malware:**
- Ransomware (WannaCry, Ryuk, REvil)
- Trojans (Emotet, TrickBot, Dridex)
- Cryptominers (XMRig, CoinHive)
- Info stealers (Formbook, Agent Tesla)
- RATs (NanoCore, DarkComet)

**Persistence Mechanisms:**
- Registry Run keys
- Scheduled tasks
- WMI subscriptions
- Services and drivers
- DLL hijacking

**Living-off-the-Land:**
- PowerShell encoded commands
- WMI abuse
- WMIC execution
- Certutil downloads
- BITSAdmin transfers

**Web Shells (IIS):**
- China Chopper
- ASPXSpy
- ASPX web shells
- PHP shells on IIS

## Remediation Steps

### If Malware is Detected

**Immediate Actions:**

1. **Isolate the System**
   - Disconnect from network
   - Block suspicious IPs
   - Disable remote access

2. **Document Everything**
   - Save security reports
   - Screenshot evidence
   - Note timestamps
   - Record IOCs (Indicators of Compromise)

3. **Analyze the Threat**
   - Review AI recommendations
   - Research detected malware
   - Determine infection vector
   - Assess damage scope

4. **Remove Threats**
   ```bash
   # Linux: Quarantine with ClamAV
   sudo clamscan -r --move=/quarantine /infected/path
   
   # Linux: Remove detected files
   sudo rm -f /path/to/malware
   
   # Windows: Use Defender to remove
   Remove-MpThreat -ThreatID <ID>
   ```

5. **Verify Removal**
   - Run scanner again
   - Check for persistence mechanisms
   - Review system logs
   - Monitor for reinfection

6. **Restore from Backup**
   - If compromised beyond recovery
   - Use clean, verified backups
   - Verify backup integrity first

### If Rootkit is Detected

**Critical Actions:**

1. **Boot from Live CD/USB**
   - System may be compromised
   - Use trusted external media
   - Run offline scan

2. **Forensic Analysis**
   - Consider professional help
   - Preserve evidence
   - Document everything

3. **Complete Rebuild**
   - Rootkits can hide deeply
   - Full OS reinstall recommended
   - Restore from verified backups

### If Web Shell is Detected

**Immediate Steps:**

1. **Remove Web Shell**
   ```bash
   # Linux
   sudo rm /var/www/html/suspicious-file.php
   
   # Windows
   Remove-Item "C:\inetpub\wwwroot\suspicious-file.aspx"
   ```

2. **Review Access Logs**
   - Identify attack source
   - Check for data exfiltration
   - Document access patterns

3. **Patch Vulnerabilities**
   - Update web applications
   - Fix file upload issues
   - Review permissions

4. **Reset Credentials**
   - Change all passwords
   - Rotate API keys
   - Update database credentials

## Automation & Scheduling

### Linux Cron Jobs

**Daily malware scan at 3:00 AM:**
```bash
# Add to crontab
crontab -e

# Add this line:
0 3 * * * /path/to/ai-security-scanner/scripts/malware-scanner.sh >> /var/log/malware-scan.log 2>&1
```

**Weekly comprehensive scan:**
```bash
0 2 * * 0 /path/to/ai-security-scanner/scripts/malware-scanner.sh >> /var/log/malware-scan-weekly.log 2>&1
```

### Windows Task Scheduler

**Daily scan at 3:00 AM:**
```powershell
$action = New-ScheduledTaskAction -Execute 'PowerShell.exe' `
    -Argument "-File `"C:\path\to\ai-security-scanner\windows\scripts\MalwareScanner.ps1`" -QuickScan"

$trigger = New-ScheduledTaskTrigger -Daily -At 3:00AM

$principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" `
    -LogonType ServiceAccount -RunLevel Highest

Register-ScheduledTask -TaskName "AI Malware Scanner" `
    -Action $action -Trigger $trigger -Principal $principal
```

**Weekly full scan:**
```powershell
$action = New-ScheduledTaskAction -Execute 'PowerShell.exe' `
    -Argument "-File `"C:\path\to\ai-security-scanner\windows\scripts\MalwareScanner.ps1`" -FullScan"

$trigger = New-ScheduledTaskTrigger -Weekly -DaysOfWeek Sunday -At 2:00AM

Register-ScheduledTask -TaskName "AI Malware Full Scanner" `
    -Action $action -Trigger $trigger -Principal $principal
```

## Integration with Notifications

### Send Alerts on Detection

**Linux with Slack:**
```bash
#!/bin/bash
./scripts/malware-scanner.sh
REPORT=$(ls -t ~/security-reports/malware_scan_*.md | head -1)

# Check if threats detected
if grep -q "THREATS DETECTED\|INFECTED" "$REPORT"; then
    ./integrations/notify.sh --platform slack \
        --title "‚ö†Ô∏è MALWARE DETECTED" \
        --file "$REPORT" \
        --severity critical
fi
```

**Windows with Teams:**
```powershell
.\MalwareScanner.ps1
$report = Get-ChildItem "$env:USERPROFILE\security-reports\malware_scan_*.md" | 
    Sort-Object LastWriteTime -Descending | 
    Select-Object -First 1

# Check if threats detected
if (Select-String -Path $report -Pattern "THREATS DETECTED|INFECTED") {
    # Send notification (implement based on your notification system)
    Send-TeamsNotification -Title "‚ö†Ô∏è MALWARE DETECTED" -File $report
}
```

## Best Practices

### Prevention

1. **Regular Updates**
   - Keep virus definitions current
   - Update operating system
   - Patch applications promptly
   - Update security tools

2. **Regular Scanning**
   - Daily quick scans
   - Weekly full scans
   - Scan after changes
   - Monitor reports

3. **System Hardening**
   - Minimize attack surface
   - Disable unnecessary services
   - Use firewalls
   - Implement least privilege

4. **Web Application Security**
   - Input validation
   - File upload restrictions
   - Regular security audits
   - WAF implementation

5. **Monitoring**
   - Review scan reports
   - Monitor system logs
   - Track file changes
   - Network traffic analysis

### Response Planning

1. **Incident Response Plan**
   - Document procedures
   - Define roles
   - Communication plan
   - Escalation process

2. **Backup Strategy**
   - Regular backups
   - Offline/offsite storage
   - Test restores
   - Verify integrity

3. **Forensics Preparation**
   - Log everything
   - Preserve evidence
   - Know when to call experts
   - Legal considerations

## Troubleshooting

### Linux Issues

**ClamAV database outdated:**
```bash
sudo freshclam
sudo systemctl restart clamav-daemon
```

**rkhunter false positives:**
```bash
# Update file properties
sudo rkhunter --propupd
```

**Scanner hangs:**
- Check disk space
- Verify AI model is running
- Check system resources
- Review logs

### Windows Issues

**Defender not updating:**
```powershell
Update-MpSignature
# OR manually
Start-Process "https://www.microsoft.com/security/portal/definitions/adl.aspx"
```

**Insufficient permissions:**
- Run PowerShell as Administrator
- Check execution policy:
  ```powershell
  Set-ExecutionPolicy Bypass -Scope Process
  ```

**Scan fails:**
- Check Windows Defender service
- Verify disk space
- Review Windows Event Logs

## Additional Resources

### Tools
- ClamAV: https://www.clamav.net/
- rkhunter: http://rkhunter.sourceforge.net/
- chkrootkit: http://www.chkrootkit.org/
- Windows Defender: https://docs.microsoft.com/en-us/windows/security/threat-protection/

### Threat Intelligence
- VirusTotal: https://www.virustotal.com/
- AlienVault OTX: https://otx.alienvault.com/
- ANY.RUN: https://any.run/
- Hybrid Analysis: https://www.hybrid-analysis.com/

### Incident Response
- SANS Incident Handler's Handbook: https://www.sans.org/reading-room/whitepapers/incident/
- NIST Incident Response Guide: https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-61r2.pdf
- CISA Incident Response: https://www.cisa.gov/incident-response

### Learning Resources
- Malware Analysis: https://www.malware-traffic-analysis.net/
- Rootkit Analysis: https://www.rootkit.com/
- Windows Forensics: https://www.sans.org/blog/

---

**Need Help?**
- GitHub Issues: https://github.com/barrersoftware/ai-security-scanner/issues
- Documentation: https://github.com/barrersoftware/ai-security-scanner/docs/
- Security Disclosure: security@yourdomain.com

---

*Stay vigilant, scan regularly, and keep your systems secure!* üõ°Ô∏è
