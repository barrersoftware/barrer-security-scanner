# Comprehensive Malware, Virus, and Rootkit Scanner for Windows
# Integrates Windows Defender, GMER, and AI analysis

param(
    [string]$Model = "llama3.1:70b",
    [switch]$QuickScan,
    [switch]$FullScan
)

$ErrorActionPreference = "Continue"
$ReportDir = "$env:USERPROFILE\security-reports"
$Timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$ReportFile = "$ReportDir\malware_scan_$Timestamp.md"

# Create report directory
if (!(Test-Path $ReportDir)) {
    New-Item -ItemType Directory -Path $ReportDir | Out-Null
}

Write-Host "================================================"
Write-Host "  COMPREHENSIVE MALWARE & ROOTKIT SCAN"
Write-Host "================================================"
Write-Host ""

# Check admin privileges
$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
if (!$isAdmin) {
    Write-Warning "Running without administrator privileges. Some checks may be limited."
    Write-Host "For best results, run as Administrator: Run PowerShell as Administrator"
}

# Initialize report
@"
# Malware, Virus & Rootkit Security Scan Report (Windows)
Generated: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
Computer: $env:COMPUTERNAME
OS: $((Get-WmiObject Win32_OperatingSystem).Caption)
Version: $((Get-WmiObject Win32_OperatingSystem).Version)

---

"@ | Out-File -FilePath $ReportFile -Encoding UTF8

# Function to query AI
function Query-AI {
    param(
        [string]$Prompt,
        [string]$Section
    )
    
    Add-Content -Path $ReportFile -Value "`n## $Section`n"
    Write-Host "Analyzing: $Section..."
    
    $body = @{
        model = $Model
        prompt = $Prompt
        stream = $false
        options = @{
            temperature = 0.3
            top_p = 0.9
        }
    } | ConvertTo-Json
    
    try {
        $response = Invoke-RestMethod -Uri "http://localhost:11434/api/generate" -Method Post -Body $body -ContentType "application/json"
        Add-Content -Path $ReportFile -Value "$($response.response)`n`n---`n"
    } catch {
        Add-Content -Path $ReportFile -Value "Error querying AI: $($_.Exception.Message)`n`n---`n"
    }
}

# 1. Windows Defender Scan
function Run-DefenderScan {
    Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')] Running Windows Defender scan..."
    
    Add-Content -Path $ReportFile -Value @"
## 1. Windows Defender Virus & Malware Scan

### Scan Configuration
- Engine: Windows Defender
- Scan Time: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
- Scan Type: $($QuickScan ? "Quick Scan" : "Full Scan")

### Windows Defender Status

``````
"@
    
    # Get Windows Defender status
    $defenderStatus = Get-MpComputerStatus
    $defenderPrefs = Get-MpPreference
    
    $statusInfo = @"
Antivirus Enabled: $($defenderStatus.AntivirusEnabled)
Antispyware Enabled: $($defenderStatus.AntispywareEnabled)
Real-time Protection: $($defenderStatus.RealTimeProtectionEnabled)
Behavior Monitoring: $($defenderStatus.BehaviorMonitorEnabled)
IOAV Protection: $($defenderStatus.IoavProtectionEnabled)
Network Inspection: $($defenderStatus.NISEnabled)

Signature Versions:
- Antivirus: $($defenderStatus.AntivirusSignatureVersion)
- Antispyware: $($defenderStatus.AntispywareSignatureVersion)
- NIS: $($defenderStatus.NISSignatureVersion)

Last Scan: $($defenderStatus.QuickScanEndTime)
Last Full Scan: $($defenderStatus.FullScanEndTime)
Last Signature Update: $($defenderStatus.AntivirusSignatureLastUpdated)
"@
    
    Add-Content -Path $ReportFile -Value $statusInfo
    Add-Content -Path $ReportFile -Value "``````"
    
    # Update definitions
    Write-Host "  Updating virus definitions..."
    try {
        Update-MpSignature -ErrorAction SilentlyContinue
        Add-Content -Path $ReportFile -Value "`n✅ Virus definitions updated successfully`n"
    } catch {
        Add-Content -Path $ReportFile -Value "`n⚠️ Could not update definitions: $($_.Exception.Message)`n"
    }
    
    # Run scan
    Write-Host "  Running antivirus scan (this may take several minutes)..."
    Add-Content -Path $ReportFile -Value "### Scan Results`n"
    
    try {
        if ($QuickScan) {
            Start-MpScan -ScanType QuickScan -ErrorAction Stop
        } else {
            Start-MpScan -ScanType FullScan -ErrorAction Stop
        }
        
        # Get threats
        $threats = Get-MpThreat
        if ($threats.Count -gt 0) {
            Add-Content -Path $ReportFile -Value "**⚠️ THREATS DETECTED:**`n"
            Add-Content -Path $ReportFile -Value "``````"
            $threats | ForEach-Object {
                Add-Content -Path $ReportFile -Value "Threat: $($_.ThreatName)"
                Add-Content -Path $ReportFile -Value "Severity: $($_.SeverityID)"
                Add-Content -Path $ReportFile -Value "Path: $($_.Resources)"
                Add-Content -Path $ReportFile -Value ""
            }
            Add-Content -Path $ReportFile -Value "``````"
        } else {
            Add-Content -Path $ReportFile -Value "✅ **No threats detected**`n"
        }
    } catch {
        Add-Content -Path $ReportFile -Value "Error running scan: $($_.Exception.Message)`n"
    }
    
    Add-Content -Path $ReportFile -Value "`n---`n"
}

# 2. Process Analysis
function Analyze-Processes {
    Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')] Analyzing running processes..."
    
    $processes = Get-Process | Select-Object Name, Id, Path, Company, Description, StartTime, @{Name="Memory(MB)";Expression={[math]::Round($_.WS/1MB,2)}} | 
        Sort-Object "Memory(MB)" -Descending | Select-Object -First 50
    
    $networkConnections = Get-NetTCPConnection -State Established | 
        Select-Object LocalAddress, LocalPort, RemoteAddress, RemotePort, State, OwningProcess |
        ForEach-Object {
            $proc = Get-Process -Id $_.OwningProcess -ErrorAction SilentlyContinue
            [PSCustomObject]@{
                LocalAddress = $_.LocalAddress
                LocalPort = $_.LocalPort
                RemoteAddress = $_.RemoteAddress
                RemotePort = $_.RemotePort
                Process = $proc.Name
                ProcessPath = $proc.Path
            }
        }
    
    # Check for suspicious processes
    $suspiciousPatterns = @(
        "powershell.*-enc",
        "cmd.*\/c.*download",
        "wscript.*\.vbs",
        "mshta.*http",
        "regsvr32.*\/s.*\/u.*\/i"
    )
    
    $suspiciousProcs = Get-Process | Where-Object {
        $cmdline = (Get-WmiObject Win32_Process -Filter "ProcessId = $($_.Id)" -ErrorAction SilentlyContinue).CommandLine
        foreach ($pattern in $suspiciousPatterns) {
            if ($cmdline -match $pattern) { return $true }
        }
        return $false
    }
    
    $processInfo = @"
Top 50 Processes by Memory:
$($processes | Format-Table -AutoSize | Out-String)

Active Network Connections:
$($networkConnections | Select-Object -First 30 | Format-Table -AutoSize | Out-String)

Suspicious Processes:
$($suspiciousProcs.Count -gt 0 ? ($suspiciousProcs | Format-List | Out-String) : "None detected")

Hidden or Unsigned Processes:
$(Get-Process | Where-Object { $_.Path -and !(Test-Path $_.Path) } | Select-Object Name, Id, Path | Format-Table | Out-String)
"@
    
    Query-AI -Prompt @"
You are a malware analyst specializing in Windows threats. Review these running processes and network connections for signs of malware, backdoors, or suspicious activity:

$processInfo

Look for:
1. Processes running from unusual locations (%TEMP%, %APPDATA%, hidden directories)
2. Suspicious network connections to unknown IPs or unusual ports
3. Processes with obfuscated or encoded commands (base64, PowerShell -enc)
4. Known malware process names or behaviors
5. Unsigned or missing executables
6. Living-off-the-land binaries (LOLBins) abuse
7. Processes with unusual parent-child relationships

Provide specific findings categorized by severity with remediation steps.
"@ -Section "2. Process & Network Analysis"
}

# 3. File System Analysis
function Analyze-FileSystem {
    Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')] Analyzing file system for malware indicators..."
    
    # Recent files in temp directories
    $tempFiles = Get-ChildItem -Path $env:TEMP, $env:TMP, "C:\Windows\Temp" -Recurse -File -ErrorAction SilentlyContinue |
        Where-Object { $_.LastWriteTime -gt (Get-Date).AddDays(-7) } |
        Select-Object -First 30 FullName, LastWriteTime, Length
    
    # Startup locations
    $startupItems = @(
        Get-ItemProperty "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -ErrorAction SilentlyContinue
        Get-ItemProperty "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run" -ErrorAction SilentlyContinue
        Get-ChildItem "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup" -ErrorAction SilentlyContinue
        Get-ChildItem "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup" -ErrorAction SilentlyContinue
    )
    
    # Scheduled tasks
    $suspiciousTasks = Get-ScheduledTask | Where-Object {
        $_.TaskPath -notmatch "Microsoft" -and $_.State -eq "Ready"
    } | Select-Object -First 20 TaskName, TaskPath, State
    
    # Hidden files in system directories
    $hiddenFiles = Get-ChildItem -Path "C:\Windows\System32", "C:\Windows\SysWOW64" -Force -File -ErrorAction SilentlyContinue |
        Where-Object { $_.Attributes -match "Hidden" } |
        Select-Object -First 20 FullName, LastWriteTime
    
    $fileInfo = @"
Recent Files in Temp Directories:
$($tempFiles | Format-Table -AutoSize | Out-String)

Startup Items:
$($startupItems | Format-List | Out-String)

Suspicious Scheduled Tasks:
$($suspiciousTasks | Format-Table -AutoSize | Out-String)

Hidden Files in System Directories:
$($hiddenFiles | Format-Table -AutoSize | Out-String)
"@
    
    Query-AI -Prompt @"
You are a forensic malware analyst specializing in Windows systems. Review these file system findings for indicators of compromise:

$fileInfo

Analyze for:
1. Suspicious files in temporary directories
2. Unauthorized startup entries (persistence mechanisms)
3. Malicious scheduled tasks
4. Hidden files in system directories
5. Unusual file extensions or naming patterns
6. Files with suspicious timestamps (timestomping)

Categorize findings by severity and provide specific remediation actions.
"@ -Section "3. File System Malware Indicators"
}

# 4. Registry Analysis
function Analyze-Registry {
    Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')] Analyzing registry for malware persistence..."
    
    $registryKeys = @(
        "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run",
        "HKLM:\Software\Microsoft\Windows\CurrentVersion\RunOnce",
        "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run",
        "HKCU:\Software\Microsoft\Windows\CurrentVersion\RunOnce",
        "HKLM:\Software\Microsoft\Windows\CurrentVersion\RunServices",
        "HKLM:\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce",
        "HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon",
        "HKLM:\System\CurrentControlSet\Services"
    )
    
    $regInfo = ""
    foreach ($key in $registryKeys) {
        if (Test-Path $key) {
            $regInfo += "`nRegistry Key: $key`n"
            $regInfo += (Get-ItemProperty $key -ErrorAction SilentlyContinue | Format-List | Out-String)
        }
    }
    
    Query-AI -Prompt @"
You are a Windows malware analyst. Review these registry entries for malware persistence mechanisms:

$regInfo

Look for:
1. Unauthorized Run/RunOnce entries
2. Suspicious Winlogon entries (Shell, Userinit, Notify)
3. Unknown services
4. DLL hijacking indicators
5. AppInit_DLLs entries
6. Image File Execution Options (IFEO) redirects
7. Browser Helper Objects (BHOs)

Identify persistence mechanisms and provide removal instructions.
"@ -Section "4. Registry Persistence Analysis"
}

# 5. Web Shell Detection
function Detect-WebShells {
    Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')] Scanning for web shells..."
    
    $webDirs = @(
        "C:\inetpub\wwwroot",
        "C:\Windows\System32\inetsrv"
    )
    
    $webShellPatterns = @("eval\(", "base64_decode", "exec\(", "shell_exec", "System\.Diagnostics\.Process")
    
    $suspiciousFiles = @()
    foreach ($dir in $webDirs) {
        if (Test-Path $dir) {
            Write-Host "  Scanning $dir..."
            $files = Get-ChildItem -Path $dir -Recurse -Include "*.asp", "*.aspx", "*.php", "*.jsp" -ErrorAction SilentlyContinue
            foreach ($file in $files) {
                $content = Get-Content $file.FullName -Raw -ErrorAction SilentlyContinue
                foreach ($pattern in $webShellPatterns) {
                    if ($content -match $pattern) {
                        $suspiciousFiles += $file.FullName
                        break
                    }
                }
            }
        }
    }
    
    Add-Content -Path $ReportFile -Value "`n## 5. Web Shell Detection`n"
    Add-Content -Path $ReportFile -Value "### Scan Configuration"
    Add-Content -Path $ReportFile -Value "- Web directories scanned: $($webDirs -join ', ')"
    Add-Content -Path $ReportFile -Value "- Patterns: eval(), base64_decode, exec(), shell_exec()`n"
    Add-Content -Path $ReportFile -Value "### Results`n"
    
    if ($suspiciousFiles.Count -eq 0) {
        Add-Content -Path $ReportFile -Value "✅ **No obvious web shells detected**`n"
    } else {
        Add-Content -Path $ReportFile -Value "**⚠️ POTENTIAL WEB SHELLS DETECTED:**`n"
        $suspiciousFiles | ForEach-Object {
            Add-Content -Path $ReportFile -Value "- $_"
        }
    }
    
    Add-Content -Path $ReportFile -Value "`n---`n"
}

# 6. Network Analysis
function Analyze-Network {
    Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')] Analyzing network configuration..."
    
    $firewallStatus = Get-NetFirewallProfile | Select-Object Name, Enabled
    $dnsCache = Get-DnsClientCache | Select-Object -First 50 Entry, Data
    $hosts = Get-Content "C:\Windows\System32\drivers\etc\hosts" -ErrorAction SilentlyContinue
    
    $networkInfo = @"
Firewall Status:
$($firewallStatus | Format-Table -AutoSize | Out-String)

Recent DNS Queries:
$($dnsCache | Format-Table -AutoSize | Out-String)

Hosts File:
$hosts

Network Shares:
$(Get-SmbShare | Format-Table -AutoSize | Out-String)

Network Adapters:
$(Get-NetAdapter | Select-Object Name, Status, MacAddress | Format-Table -AutoSize | Out-String)
"@
    
    Query-AI -Prompt @"
You are a network security analyst. Review this Windows network configuration for malware indicators:

$networkInfo

Look for:
1. Firewall misconfigurations
2. Suspicious DNS queries or patterns
3. Malicious hosts file entries
4. Unauthorized network shares
5. Signs of command and control (C2) communication
6. DNS tunneling indicators

Provide findings with security recommendations.
"@ -Section "6. Network Configuration Analysis"
}

# 7. Generate AI Summary
function Generate-AISummary {
    Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')] Generating AI analysis summary..."
    
    $scanResults = Get-Content $ReportFile -Raw
    
    Query-AI -Prompt @"
You are a senior cybersecurity analyst specializing in Windows malware detection and incident response. Review this comprehensive malware and rootkit scan report:

$scanResults

Provide:
1. **Executive Summary** - Overall security posture regarding malware/rootkits
2. **Critical Findings** - Issues requiring immediate attention
3. **Risk Assessment** - Likelihood of active compromise (Low/Medium/High/Critical)
4. **Detailed Recommendations** - Specific remediation steps prioritized by urgency
5. **Prevention Measures** - Steps to prevent future infections

Be specific, actionable, and prioritize findings by severity. Focus on Windows-specific threats and remediation.
"@ -Section "7. AI Analysis & Recommendations"
}

# Main execution
function Main {
    Write-Host "Starting comprehensive Windows malware and rootkit scan..."
    Write-Host "This may take 15-45 minutes depending on scan type and system size."
    Write-Host ""
    
    Run-DefenderScan
    Analyze-Processes
    Analyze-FileSystem
    Analyze-Registry
    Detect-WebShells
    Analyze-Network
    Generate-AISummary
    
    # Add summary footer
    $footer = @"

---

## Scan Complete

**Report Location:** $ReportFile
**Scan Duration:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
**Next Recommended Scan:** $((Get-Date).AddDays(7).ToString('yyyy-MM-dd'))

### Quick Remediation Checklist

- [ ] Review all CRITICAL findings above
- [ ] Quarantine or remove detected malware
- [ ] Update Windows Defender definitions
- [ ] Apply Windows security patches
- [ ] Review and secure IIS/web applications
- [ ] Monitor Event Logs for continued suspicious activity
- [ ] Consider forensic analysis if compromise suspected

### Additional Resources

- Windows Defender: https://docs.microsoft.com/en-us/windows/security/threat-protection/
- SANS Incident Response: https://www.sans.org/incident-response/
- Microsoft Security Response Center: https://www.microsoft.com/en-us/msrc
- Sysinternals Suite: https://docs.microsoft.com/en-us/sysinternals/

---

*Generated by AI Security Scanner - Malware & Rootkit Module (Windows)*
*https://github.com/ssfdre38/ai-security-scanner*
"@
    
    Add-Content -Path $ReportFile -Value $footer
    
    Write-Host ""
    Write-Host "================================================"
    Write-Host "  SCAN COMPLETE"
    Write-Host "================================================"
    Write-Host ""
    Write-Host "Report saved to: $ReportFile"
    Write-Host ""
    Write-Host "To view the report:"
    Write-Host "  notepad $ReportFile"
    Write-Host ""
}

# Run main function
Main
