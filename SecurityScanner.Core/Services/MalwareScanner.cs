namespace SecurityScanner.Core.Services;

using System.Diagnostics;
using SecurityScanner.Core.Models;

public class MalwareScanner
{
    public async Task<List<Finding>> ScanAsync(string? targetPath = null, CancellationToken cancellationToken = default)
    {
        var findings = new List<Finding>();

        await ScanWithClamAVAsync(findings, targetPath, cancellationToken);
        await CheckSuspiciousProcessesAsync(findings, cancellationToken);

        return findings;
    }

    private async Task ScanWithClamAVAsync(List<Finding> findings, string? targetPath, CancellationToken cancellationToken)
    {
        try
        {
            var scanPath = targetPath ?? "/home";
            var psi = new ProcessStartInfo
            {
                FileName = "clamscan",
                Arguments = $"-r {scanPath}",
                RedirectStandardOutput = true,
                UseShellExecute = false
            };

            using var process = Process.Start(psi);
            if (process != null)
            {
                var output = await process.StandardOutput.ReadToEndAsync(cancellationToken);
                await process.WaitForExitAsync(cancellationToken);

                if (output.Contains("Infected files:"))
                {
                    var lines = output.Split('\n');
                    foreach (var line in lines)
                    {
                        if (line.Contains("FOUND"))
                        {
                            findings.Add(new Finding
                            {
                                Id = Guid.NewGuid().ToString(),
                                Title = "Malware Detected",
                                Description = line.Trim(),
                                Severity = Severity.Critical,
                                Category = "Malware",
                                Remediation = "Quarantine and remove infected file immediately"
                            });
                        }
                    }
                }
            }
        }
        catch { }
    }

    private async Task CheckSuspiciousProcessesAsync(List<Finding> findings, CancellationToken cancellationToken)
    {
        try
        {
            var processes = Process.GetProcesses();
            var suspiciousNames = new[] { "nc", "ncat", "netcat", "cryptominer" };

            foreach (var proc in processes)
            {
                try
                {
                    if (suspiciousNames.Any(s => proc.ProcessName.ToLower().Contains(s)))
                    {
                        findings.Add(new Finding
                        {
                            Id = Guid.NewGuid().ToString(),
                            Title = "Suspicious Process Detected",
                            Description = $"Process '{proc.ProcessName}' (PID: {proc.Id}) may be malicious",
                            Severity = Severity.High,
                            Category = "Malware",
                            Remediation = "Investigate and terminate if confirmed malicious"
                        });
                    }
                }
                catch { }
            }
        }
        catch { }
    }
}
