namespace SecurityScanner.Core.Services;

using System.Diagnostics;
using SecurityScanner.Core.Models;

public class MalwareScanner
{
    private readonly AntivirusDetectionService _detectionService;

    public MalwareScanner(AntivirusDetectionService detectionService)
    {
        _detectionService = detectionService;
    }

    public async Task<List<Finding>> ScanAsync(string? targetPath = null, CancellationToken cancellationToken = default)
    {
        var findings = new List<Finding>();

        // Detect what AV they have installed
        var installedAV = await _detectionService.DetectInstalledAntivirusAsync(cancellationToken);

        if (installedAV != null)
        {
            // Use their existing antivirus
            await ScanWithInstalledAVAsync(findings, installedAV, targetPath, cancellationToken);
        }
        else
        {
            // No AV detected - recommend installing one
            findings.Add(new Finding
            {
                Id = Guid.NewGuid().ToString(),
                Title = "No Antivirus Detected",
                Description = "No antivirus software found on system",
                Severity = Severity.High,
                Category = "Malware",
                Remediation = "Install antivirus software (ClamAV, Sophos, etc.)"
            });
        }

        await CheckSuspiciousProcessesAsync(findings, cancellationToken);

        return findings;
    }

    private async Task ScanWithInstalledAVAsync(List<Finding> findings, InstalledAntivirus av, string? targetPath, CancellationToken cancellationToken)
    {
        findings.Add(new Finding
        {
            Id = Guid.NewGuid().ToString(),
            Title = $"Using Detected Antivirus: {av.Name}",
            Description = $"Scanning with {av.Name} ({av.Type})",
            Severity = Severity.Low,
            Category = "Info",
            Remediation = "Using your existing antivirus installation"
        });

        // Use their specific AV command
        await ScanWithGenericAVAsync(findings, av.ScanCommand, targetPath, cancellationToken);
    }

    private async Task ScanWithGenericAVAsync(List<Finding> findings, string command, string? targetPath, CancellationToken cancellationToken)
    {
        try
        {
            var scanPath = targetPath ?? "/home";
            var psi = new ProcessStartInfo
            {
                FileName = command,
                Arguments = $"-r {scanPath}",
                RedirectStandardOutput = true,
                UseShellExecute = false
            };

            using var process = Process.Start(psi);
            if (process != null)
            {
                var output = await process.StandardOutput.ReadToEndAsync(cancellationToken);
                await process.WaitForExitAsync(cancellationToken);

                ParseAntivirusOutput(output, findings);
            }
        }
        catch { }
    }

    private async Task ScanWithClamAVAsync(List<Finding> findings, string? targetPath, CancellationToken cancellationToken)
    {
        try
        {
            var scanPath = targetPath ?? "/home";
            var psi = new ProcessStartInfo
            {
                FileName = "clamscan",
                Arguments = $"-r {scanPath}",
                RedirectStandardOutput = true,
                UseShellExecute = false
            };

            using var process = Process.Start(psi);
            if (process != null)
            {
                var output = await process.StandardOutput.ReadToEndAsync(cancellationToken);
                await process.WaitForExitAsync(cancellationToken);

                ParseAntivirusOutput(output, findings);
            }
        }
        catch { }
    }

    private void ParseAntivirusOutput(string output, List<Finding> findings)
    {
        var lines = output.Split('\n');
        foreach (var line in lines)
        {
            if (line.Contains("FOUND") || line.Contains("Infected") || line.Contains("Virus"))
            {
                findings.Add(new Finding
                {
                    Id = Guid.NewGuid().ToString(),
                    Title = "Malware Detected",
                    Description = line.Trim(),
                    Severity = Severity.Critical,
                    Category = "Malware",
                    Remediation = "Quarantine and remove infected file immediately"
                });
            }
        }
    }

    private async Task CheckSuspiciousProcessesAsync(List<Finding> findings, CancellationToken cancellationToken)
    {
        try
        {
            var processes = Process.GetProcesses();
            var suspiciousNames = new[] { "nc", "ncat", "netcat", "cryptominer" };

            foreach (var proc in processes)
            {
                try
                {
                    if (suspiciousNames.Any(s => proc.ProcessName.ToLower().Contains(s)))
                    {
                        findings.Add(new Finding
                        {
                            Id = Guid.NewGuid().ToString(),
                            Title = "Suspicious Process Detected",
                            Description = $"Process '{proc.ProcessName}' (PID: {proc.Id}) may be malicious",
                            Severity = Severity.High,
                            Category = "Malware",
                            Remediation = "Investigate and terminate if confirmed malicious"
                        });
                    }
                }
                catch { }
            }
        }
        catch { }
    }
}
