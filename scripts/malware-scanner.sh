#!/bin/bash
# Comprehensive Malware, Virus, and Rootkit Scanner
# Integrates ClamAV, rkhunter, chkrootkit, and AI analysis

set -e

MODEL="llama3.1:70b"
REPORT_DIR="/home/ubuntu/security-reports"
mkdir -p "$REPORT_DIR"
TIMESTAMP=$(date -u +%Y%m%d_%H%M%S)
REPORT_FILE="$REPORT_DIR/malware_scan_$TIMESTAMP.md"

echo "================================================"
echo "  COMPREHENSIVE MALWARE & ROOTKIT SCAN"
echo "================================================"
echo ""

# Check if running as root
if [ "$EUID" -ne 0 ]; then 
    echo "Warning: Running without root privileges. Some checks may be limited."
    echo "For best results, run with: sudo $0"
fi

# Initialize report
cat > "$REPORT_FILE" <<EOF
# Malware, Virus & Rootkit Security Scan Report
Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
System: $(hostname)
OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2 || echo "Unknown")
Kernel: $(uname -r)

---

EOF

# Function to query AI
query_ai() {
    local prompt="$1"
    local section="$2"
    
    echo "## $section" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    echo "Analyzing: $section..."
    
    response=$(curl -s http://localhost:11434/api/generate -d "{
        \"model\": \"$MODEL\",
        \"prompt\": \"$prompt\",
        \"stream\": false,
        \"options\": {
            \"temperature\": 0.3,
            \"top_p\": 0.9
        }
    }" | jq -r '.response')
    
    echo "$response" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    echo "---" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
}

# Check and install tools if needed
check_tools() {
    echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] Checking required tools..."
    
    local missing_tools=()
    
    if ! command -v clamscan &> /dev/null; then
        missing_tools+=("clamav")
    fi
    
    if ! command -v rkhunter &> /dev/null; then
        missing_tools+=("rkhunter")
    fi
    
    if ! command -v chkrootkit &> /dev/null; then
        missing_tools+=("chkrootkit")
    fi
    
    if [ ${#missing_tools[@]} -gt 0 ]; then
        echo "Missing tools: ${missing_tools[*]}"
        echo "Installing required malware detection tools..."
        
        if command -v apt-get &> /dev/null; then
            sudo apt-get update -qq
            for tool in "${missing_tools[@]}"; do
                sudo apt-get install -y "$tool" 2>&1 | grep -v "^Get:\|^Hit:\|^Ign:" || true
            done
            
            # Update ClamAV database
            if [[ " ${missing_tools[*]} " =~ " clamav " ]]; then
                echo "Updating ClamAV virus definitions (this may take a few minutes)..."
                sudo freshclam 2>&1 | tail -5 || true
            fi
            
            # Update rkhunter
            if [[ " ${missing_tools[*]} " =~ " rkhunter " ]]; then
                echo "Updating rkhunter database..."
                sudo rkhunter --update 2>&1 | tail -5 || true
            fi
        elif command -v yum &> /dev/null; then
            for tool in "${missing_tools[@]}"; do
                sudo yum install -y "$tool" 2>&1 | tail -10 || true
            done
            [ -f /usr/bin/freshclam ] && sudo freshclam 2>&1 | tail -5 || true
            [ -f /usr/bin/rkhunter ] && sudo rkhunter --update 2>&1 | tail -5 || true
        else
            echo "Error: Package manager not supported. Please install manually: ${missing_tools[*]}"
            exit 1
        fi
    else
        echo "All required tools are installed."
    fi
}

# 1. ClamAV Virus Scan
run_clamav_scan() {
    echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] Running ClamAV virus scan..."
    
    cat >> "$REPORT_FILE" <<EOF
## 1. ClamAV Virus & Malware Scan

### Scan Configuration
- Engine: ClamAV $(clamscan --version 2>/dev/null | head -1)
- Database Version: $(sigtool --info /var/lib/clamav/daily.cvd 2>/dev/null | grep "Build time" || echo "Unknown")
- Scan Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

### Scan Results

EOF
    
    # Update virus definitions if older than 7 days
    if [ -f /var/lib/clamav/daily.cvd ]; then
        if [ $(find /var/lib/clamav/daily.cvd -mtime +7 2>/dev/null | wc -l) -gt 0 ]; then
            echo "Updating ClamAV definitions (older than 7 days)..."
            sudo freshclam 2>&1 | tail -5 || true
        fi
    fi
    
    # Scan critical directories
    SCAN_DIRS=("/home" "/root" "/tmp" "/var/www" "/var/tmp" "/opt" "/usr/local")
    CLAM_RESULTS=""
    
    for dir in "${SCAN_DIRS[@]}"; do
        if [ -d "$dir" ]; then
            echo "  Scanning $dir..."
            result=$(clamscan -r -i --exclude-dir="^/proc\|^/sys\|^/dev" "$dir" 2>&1 || true)
            if [ -n "$result" ]; then
                CLAM_RESULTS="$CLAM_RESULTS\n\n**Directory: $dir**\n\`\`\`\n$result\n\`\`\`"
            fi
        fi
    done
    
    if [ -z "$CLAM_RESULTS" ]; then
        echo "✅ **No viruses or malware detected**" >> "$REPORT_FILE"
    else
        echo "**⚠️ THREATS DETECTED:**" >> "$REPORT_FILE"
        echo -e "$CLAM_RESULTS" >> "$REPORT_FILE"
    fi
    
    echo "" >> "$REPORT_FILE"
    echo "---" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
}

# 2. Rootkit Hunter (rkhunter)
run_rkhunter_scan() {
    echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] Running Rootkit Hunter scan..."
    
    cat >> "$REPORT_FILE" <<EOF
## 2. Rootkit Hunter (rkhunter) Scan

### Scan Configuration
- Tool: $(rkhunter --version 2>/dev/null | head -1 || echo "rkhunter")
- Scan Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

### Scan Results

EOF
    
    # Update rkhunter database
    echo "  Updating rkhunter database..."
    sudo rkhunter --update 2>&1 | tail -3 || true
    
    # Run rkhunter scan
    echo "  Running rootkit scan..."
    RKHUNTER_LOG="/tmp/rkhunter_$TIMESTAMP.log"
    sudo rkhunter --check --skip-keypress --report-warnings-only > "$RKHUNTER_LOG" 2>&1 || true
    
    if [ -s "$RKHUNTER_LOG" ]; then
        echo "\`\`\`" >> "$REPORT_FILE"
        cat "$RKHUNTER_LOG" >> "$REPORT_FILE"
        echo "\`\`\`" >> "$REPORT_FILE"
    else
        echo "✅ **No rootkits detected**" >> "$REPORT_FILE"
    fi
    
    rm -f "$RKHUNTER_LOG"
    
    echo "" >> "$REPORT_FILE"
    echo "---" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
}

# 3. chkrootkit Scan
run_chkrootkit_scan() {
    echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] Running chkrootkit scan..."
    
    cat >> "$REPORT_FILE" <<EOF
## 3. chkrootkit Scan

### Scan Configuration
- Tool: chkrootkit
- Scan Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

### Scan Results

EOF
    
    # Run chkrootkit
    echo "  Scanning for rootkits..."
    CHKROOT_LOG="/tmp/chkrootkit_$TIMESTAMP.log"
    sudo chkrootkit > "$CHKROOT_LOG" 2>&1 || true
    
    # Extract suspicious findings
    SUSPICIOUS=$(grep -i "INFECTED\|WARNING\|vulnerable" "$CHKROOT_LOG" || true)
    
    if [ -n "$SUSPICIOUS" ]; then
        echo "**⚠️ Suspicious findings:**" >> "$REPORT_FILE"
        echo "\`\`\`" >> "$REPORT_FILE"
        echo "$SUSPICIOUS" >> "$REPORT_FILE"
        echo "\`\`\`" >> "$REPORT_FILE"
    else
        echo "✅ **No suspicious rootkit activity detected**" >> "$REPORT_FILE"
    fi
    
    rm -f "$CHKROOT_LOG"
    
    echo "" >> "$REPORT_FILE"
    echo "---" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
}

# 4. Process Analysis
analyze_processes() {
    echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] Analyzing running processes..."
    
    PROCESS_INFO=$(cat <<EOF
Running Processes:
$(ps auxf --sort=-%mem | head -50)

Network Connections:
$(ss -tupn 2>/dev/null | grep ESTAB || netstat -tupn 2>/dev/null | grep ESTABLISHED)

Hidden Processes Check:
$(ps -ef | awk '{print $2}' | sort -u > /tmp/ps.txt; ls /proc | grep -E '^[0-9]+$' | sort -u > /tmp/proc.txt; diff /tmp/ps.txt /tmp/proc.txt || echo "All processes accounted for"; rm -f /tmp/ps.txt /tmp/proc.txt)

Suspicious Process Names:
$(ps aux | grep -E "nc|ncat|netcat|wget|curl.*http|perl.*socket|python.*socket|/tmp/\.|\.\./" | grep -v grep || echo "None detected")
EOF
)
    
    query_ai "You are a malware analyst. Review these running processes and network connections for signs of malware, backdoors, or suspicious activity:

$PROCESS_INFO

Look for:
1. Processes running from unusual locations (/tmp, /dev/shm, hidden directories)
2. Suspicious network connections to unknown IPs
3. Processes with obfuscated or random names
4. Hidden processes (discrepancies between ps and /proc)
5. Known malware process signatures
6. Processes with unusual resource consumption

Provide specific findings and remediation steps." "4. Process & Network Analysis"
}

# 5. File System Analysis
analyze_filesystem() {
    echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] Analyzing file system for malware indicators..."
    
    FILE_INFO=$(cat <<EOF
Recently Modified Files in /tmp:
$(find /tmp -type f -mtime -7 2>/dev/null | head -20)

Recently Modified Files in /var/tmp:
$(find /var/tmp -type f -mtime -7 2>/dev/null | head -20)

Recently Modified SUID Binaries:
$(find / -perm -4000 -mtime -30 2>/dev/null | head -20)

Hidden Files in System Directories:
$(find /etc /usr /var -name ".*" -type f 2>/dev/null | grep -v ".cache\|.config\|.git" | head -30)

World-Writable Directories:
$(find / -xdev -type d -perm -0002 2>/dev/null | grep -v "/proc\|/sys\|/dev" | head -20)

Suspicious Shell Scripts in /tmp:
$(find /tmp /var/tmp -name "*.sh" -o -name "*.pl" -o -name "*.py" 2>/dev/null | head -20)

Files with No User:
$(find / -xdev -nouser -o -nogroup 2>/dev/null | head -20)
EOF
)
    
    query_ai "You are a forensic malware analyst. Review these file system findings for indicators of compromise:

$FILE_INFO

Analyze for:
1. Suspicious files in temporary directories
2. Recently modified SUID binaries (potential privilege escalation)
3. Hidden files in system directories
4. World-writable directories (attack vectors)
5. Orphaned files (no owner)
6. Suspicious scripts or executables

Categorize findings by severity and provide specific remediation actions." "5. File System Malware Indicators"
}

# 6. Web Shell Detection
detect_web_shells() {
    echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] Scanning for web shells..."
    
    WEB_DIRS=("/var/www" "/usr/share/nginx" "/home/*/public_html")
    WEB_SHELL_INFO=""
    
    for dir_pattern in "${WEB_DIRS[@]}"; do
        for dir in $dir_pattern; do
            if [ -d "$dir" ]; then
                echo "  Scanning $dir..."
                
                # Common web shell patterns
                SUSPICIOUS_FILES=$(find "$dir" -type f \( -name "*.php" -o -name "*.asp" -o -name "*.aspx" -o -name "*.jsp" \) -exec grep -l -E "eval\(|base64_decode\(|exec\(|shell_exec\(|system\(|passthru\(|proc_open\(|popen\(|curl_exec\(|assert\(|preg_replace.*\/e|\.replace.*eval" {} \; 2>/dev/null | head -20 || true)
                
                if [ -n "$SUSPICIOUS_FILES" ]; then
                    WEB_SHELL_INFO="$WEB_SHELL_INFO\n\n**Directory: $dir**\nSuspicious files:\n$SUSPICIOUS_FILES"
                fi
            fi
        done
    done
    
    cat >> "$REPORT_FILE" <<EOF
## 6. Web Shell Detection

### Scan Configuration
- Web directories scanned: ${WEB_DIRS[*]}
- Patterns: eval(), base64_decode(), exec(), shell_exec(), system()

### Results

EOF
    
    if [ -z "$WEB_SHELL_INFO" ]; then
        echo "✅ **No obvious web shells detected**" >> "$REPORT_FILE"
    else
        echo "**⚠️ POTENTIAL WEB SHELLS DETECTED:**" >> "$REPORT_FILE"
        echo -e "$WEB_SHELL_INFO" >> "$REPORT_FILE"
    fi
    
    echo "" >> "$REPORT_FILE"
    echo "---" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
}

# 7. AI Summary and Recommendations
generate_ai_summary() {
    echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] Generating AI analysis summary..."
    
    # Read the entire report so far
    SCAN_RESULTS=$(cat "$REPORT_FILE")
    
    query_ai "You are a senior cybersecurity analyst specializing in malware detection and incident response. Review this comprehensive malware and rootkit scan report:

$SCAN_RESULTS

Provide:
1. **Executive Summary** - Overall security posture regarding malware/rootkits
2. **Critical Findings** - Issues requiring immediate attention
3. **Risk Assessment** - Likelihood of active compromise
4. **Detailed Recommendations** - Specific remediation steps prioritized by urgency
5. **Prevention Measures** - Steps to prevent future infections

Be specific, actionable, and prioritize findings by severity." "7. AI Analysis & Recommendations"
}

# Main execution
main() {
    echo "Starting comprehensive malware and rootkit scan..."
    echo "This may take 10-30 minutes depending on system size."
    echo ""
    
    check_tools
    echo ""
    
    run_clamav_scan
    run_rkhunter_scan
    run_chkrootkit_scan
    analyze_processes
    analyze_filesystem
    detect_web_shells
    generate_ai_summary
    
    # Add summary footer
    cat >> "$REPORT_FILE" <<EOF

---

## Scan Complete

**Report Location:** $REPORT_FILE
**Scan Duration:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
**Next Recommended Scan:** $(date -u -d '+1 week' '+%Y-%m-%d')

### Quick Remediation Checklist

- [ ] Review all CRITICAL findings above
- [ ] Quarantine or remove detected malware
- [ ] Update all antivirus definitions
- [ ] Patch vulnerable software
- [ ] Review and secure web applications
- [ ] Monitor logs for continued suspicious activity
- [ ] Consider forensic analysis if compromise suspected

### Additional Resources

- ClamAV: https://www.clamav.net/
- rkhunter: http://rkhunter.sourceforge.net/
- chkrootkit: http://www.chkrootkit.org/
- SANS Incident Response: https://www.sans.org/incident-response/

---

*Generated by AI Security Scanner - Malware & Rootkit Module*
*https://github.com/barrersoftware/ai-security-scanner*
EOF
    
    echo ""
    echo "================================================"
    echo "  SCAN COMPLETE"
    echo "================================================"
    echo ""
    echo "Report saved to: $REPORT_FILE"
    echo ""
    echo "To view the report:"
    echo "  cat $REPORT_FILE | less"
    echo ""
    echo "Or open in your browser:"
    echo "  firefox $REPORT_FILE"
    echo ""
}

# Run main function
main

exit 0
